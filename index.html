<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Anfal</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '337677301926610');
    fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none" 
         src="https://www.facebook.com/tr?id=337677301926610&ev=PageView&noscript=1"/>
  </noscript>
  <!-- End Meta Pixel Code -->
  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 2; /* Standard property for future compatibility */
    }
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
  <!-- Banner -->
  <div class="bg-red-600 text-white text-center py-2 text-sm md:text-base">
    Stock Clearance Sale - Grab Your Favorites Now!
  </div>
  
  <!-- Header -->
  <header class="bg-white shadow sticky top-0 z-50">
    <div class="container mx-auto flex items-center justify-between py-3 px-4 md:py-4">
      <div class="flex items-center cursor-pointer" onclick="resetToHome()">
        <img src="logo.png" alt="The Anfal Logo" class="h-8 md:h-10 mr-3" onerror="this.src='https://via.placeholder.com/100x40?text=Logo'">
        <h1 class="text-lg md:text-xl font-bold">The Anfal</h1>
      </div>
      <div class="flex items-center space-x-2 md:space-x-4">
        <input id="searchInput" type="text" placeholder="Search by title or model..." class="w-40 md:w-64 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base">
        <button id="cartButton" class="relative" aria-label="View Cart">
          <img src="cart-icon.png" alt="Cart" class="h-6 md:h-8" onerror="this.src='https://via.placeholder.com/32?text=Cart'">
          <span id="cartCount" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full px-2 text-xs">0</span>
        </button>
      </div>
    </div>
    <!-- Cart Dropdown Notification -->
    <div id="cartDropdown" class="absolute right-4 top-16 w-72 md:w-80 bg-white rounded-lg shadow-xl hidden z-50">
      <div class="p-4">
        <h3 class="text-sm font-semibold mb-2 text-blue-600">Added to Cart</h3>
        <div id="cartDropdownItem" class="flex items-center space-x-3">
          <img id="cartDropdownImage" src="" alt="Product" class="w-12 h-12 object-contain rounded">
          <div>
            <p id="cartDropdownModel" class="text-xs font-medium line-clamp-1"></p>
            <p id="cartDropdownTitle" class="text-xs text-gray-600 line-clamp-1"></p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto py-4 md:py-6 px-4">
    <!-- Category Buttons -->
    <div id="categoryButtons" class="flex flex-wrap gap-2 mb-4 md:mb-6 justify-center"></div>
    <!-- Loading and Error messages -->
    <div id="loading" class="text-base md:text-lg text-center">Loading products...</div>
    <div id="error" class="text-red-600 hidden text-center text-sm md:text-base"></div>
    <!-- Products Grid -->
    <div id="products" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6"></div>
    <!-- Pagination -->
    <div id="pagination" class="flex justify-center gap-4 mt-4 md:mt-6"></div>
  </main>

  <!-- Variation Modal Popup -->
  <div id="variationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center px-4 z-50">
    <div class="bg-white p-4 md:p-6 rounded-lg w-full max-w-md max-h-[90vh] flex flex-col">
      <h3 id="variationModalTitle" class="text-lg md:text-xl font-bold mb-4 line-clamp-2"></h3>
      <div id="variationModalGrid" class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-3 flex-1 overflow-y-auto no-scrollbar"></div>
      <div id="variationPagination" class="flex justify-center gap-4 mt-4"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="closeVariationModal" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm md:text-base">Cancel</button>
        <button id="confirmVariation" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm md:text-base">Add to Cart</button>
      </div>
    </div>
  </div>

  <!-- Product Popup -->
  <div id="productPopup" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center px-4 z-50">
    <div class="bg-white p-4 md:p-6 rounded-lg w-full max-w-md">
      <h3 id="productPopupTitle" class="text-lg md:text-xl font-bold mb-4 line-clamp-2"></h3>
      <img id="productPopupImage" src="" alt="Product" class="w-full h-48 md:h-64 object-contain rounded mb-4">
      <p id="productPopupDescription" class="text-sm text-gray-600 mb-4 line-clamp-3"></p>
      <p id="productPopupPrice" class="text-base md:text-base font-medium mb-4"></p>
      <div class="flex justify-end gap-2">
        <button id="closeProductPopup" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm md:text-base">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
        <button id="productPopupSelect" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm md:text-base"></button>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center px-4 z-50">
    <div class="bg-white p-4 md:p-6 rounded-lg w-full max-w-lg max-h-[90vh] flex flex-col">
      <h2 class="text-lg md:text-xl font-bold mb-4">Your Cart</h2>
      <ul id="cartItems" class="space-y-3 mb-4 flex-1 overflow-y-auto no-scrollbar"></ul>
      <div class="border-t pt-4">
        <p class="flex justify-between text-sm md:text-base">
          Subtotal: <span>AED <span id="cartSubtotal">0.00</span></span>
        </p>
        <p class="flex justify-between text-sm md:text-base">
          Courier: <span id="courierFee">AED 15.00</span>
        </p>
        <p class="flex justify-between font-semibold text-sm md:text-base">
          Total: <span>AED <span id="cartTotal">0.00</span></span>
        </p>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="closeCart" class="px-3 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 text-sm md:text-base">Close</button>
        <button id="checkout" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm md:text-base">Checkout via WhatsApp</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-6">
    <div class="container mx-auto text-center px-4">
      <p class="text-sm md:text-base">
        Contact: <a href="https://wa.me/+971568743529" target="_blank" class="underline hover:text-blue-300">+971-568-743529</a> | 
        <a href="mailto:Admin@theanfal.com" class="underline hover:text-blue-300">Admin@theanfal.com</a>
      </p>
      <p class="text-xs md:text-sm mt-1">(c) 2025 The Anfal Dot Com LLC</p>
      <p class="text-xs mt-1">This site uses cookies and tracking technologies, including Meta Pixel, to enhance your experience and analyze site traffic. By continuing to use this site, you consent to our use of cookies. Learn more in our <a href="/privacy-policy" class="underline hover:text-blue-300">Privacy Policy</a>.</p>
      <div class="flex justify-center gap-4 mt-3">
        <a href="https://facebook.com/anfaltrends" target="_blank" aria-label="Facebook">
          <img src="facebook.png" alt="Facebook" class="h-6 md:h-8" onerror="this.src='https://via.placeholder.com/32?text=FB'">
        </a>
        <a href="https://instagram.com/anfaltrends" target="_blank" aria-label="Instagram">
          <img src="instagram.png" alt="Instagram" class="h-6 md:h-8" onerror="this.src='https://via.placeholder.com/32?text=IG'">
        </a>
      </div>
    </div>
  </footer>

  <!-- Back to Top Button -->
  <button id="backToTop" class="fixed bottom-4 right-4 bg-blue-600 text-white rounded-full p-2 hover:bg-blue-700 hidden z-40" aria-label="Back to Top">
    <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
    </svg>
  </button>

  <script>
    const loading = document.getElementById("loading");
    const error = document.getElementById("error");
    const categoryButtons = document.getElementById("categoryButtons");
    const productsGrid = document.getElementById("products");
    const pagination = document.getElementById("pagination");
    const cartButton = document.getElementById("cartButton");
    const cartModal = document.getElementById("cartModal");
    const cartItems = document.getElementById("cartItems");
    const cartSubtotal = document.getElementById("cartSubtotal");
    const courierFee = document.getElementById("courierFee");
    const cartTotal = document.getElementById("cartTotal");
    const cartCount = document.getElementById("cartCount");
    const closeCart = document.getElementById("closeCart");
    const checkout = document.getElementById("checkout");
    const cartDropdown = document.getElementById("cartDropdown");
    const cartDropdownImage = document.getElementById("cartDropdownImage");
    const cartDropdownModel = document.getElementById("cartDropdownModel");
    const cartDropdownTitle = document.getElementById("cartDropdownTitle");
    const productPopup = document.getElementById("productPopup");
    const productPopupImage = document.getElementById("productPopupImage");
    const productPopupTitle = document.getElementById("productPopupTitle");
    const productPopupDescription = document.getElementById("productPopupDescription");
    const productPopupPrice = document.getElementById("productPopupPrice");
    const productPopupSelect = document.getElementById("productPopupSelect");
    const closeProductPopup = document.getElementById("closeProductPopup");
    const searchInput = document.getElementById("searchInput");
    const backToTop = document.getElementById("backToTop");

    let allProducts = [];
    let groupedProducts = [];
    let cart = [];
    let currentCategory = "Featured";
    let currentSearchQuery = "";
    const productsPerPage = 50;
    let currentPage = 1;
    let selectedVariant = null;
    let currentGroupForModal = null;
    let variationPage = 1;
    const variationsPerPage = 6;
    let filteredGroupsCache = null;

    // Debounce utility
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function resetToHome() {
      currentCategory = "Featured";
      currentSearchQuery = "";
      currentPage = 1;
      searchInput.value = "";
      filteredGroupsCache = null;
      categoryButtons.querySelectorAll("button").forEach(b => b.classList.remove("bg-blue-800"));
      categoryButtons.querySelector("[data-category='Featured']").classList.add("bg-blue-800");
      displayProducts(currentCategory, currentSearchQuery);
    }

    function loadCart() {
      const stored = localStorage.getItem("cart");
      if (stored) {
        try {
          cart = JSON.parse(stored);
        } catch (e) {
          cart = [];
        }
      }
    }

    function updateCart() {
      cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
      cartItems.innerHTML = cart
        .map((item, index) => `
          <li class="flex items-center justify-between border-b py-2">
            <div class="flex items-center space-x-3 flex-1">
              <img src="${item.image}" alt="${item.title}" class="w-12 h-12 object-contain rounded" onerror="this.src='https://via.placeholder.com/48?text=Product'">
              <div class="flex-1">
                <p class="text-xs md:text-sm font-medium line-clamp-1">SKU: ${item.sku}</p>
                <p class="text-xs text-gray-600 line-clamp-1">${item.title.split("|")[0]}</p>
              </div>
            </div>
            <div class="flex items-center gap-2 shrink-0">
              <button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 decrease-qty text-sm" data-index="${index}">-</button>
              <span class="w-6 md:w-8 text-center text-sm">${item.quantity}</span>
              <button class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 increase-qty text-sm" data-index="${index}">+</button>
            </div>
            <span class="w-16 md:w-20 text-right font-medium text-sm">AED ${(item.price * item.quantity).toFixed(2)}</span>
          </li>
        `)
        .join("");
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const courier = subtotal > 100 ? 0 : 15;
      const total = subtotal + courier;
      cartSubtotal.textContent = subtotal.toFixed(2);
      courierFee.textContent = `AED ${courier.toFixed(2)}`;
      cartTotal.textContent = total.toFixed(2);
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function showCartDropdown(product) {
      cartDropdownImage.src = product.image;
      cartDropdownImage.onerror = () => { this.src = 'https://via.placeholder.com/48?text=Product'; };
      cartDropdownModel.textContent = `Model: ${product.model}`;
      cartDropdownTitle.textContent = product.title.replace(/\|.*/g, '');
      cartDropdown.classList.remove("hidden");
      setTimeout(() => {
        cartDropdown.classList.add("hidden");
      }, 3000);
    }

    cartItems.addEventListener("click", e => {
      if (e.target.classList.contains("increase-qty")) {
        const index = e.target.dataset.index;
        cart[index].quantity++;
        updateCart();
      } else if (e.target.classList.contains("decrease-qty")) {
        const index = e.target.dataset.index;
        if (cart[index].quantity > 1) {
          cart[index].quantity--;
        } else {
          cart.splice(index, 1);
        }
        updateCart();
      }
    });

    function openVariationModal(model) {
      const group = groupedProducts.find(g => g.model === model);
      if (!group) return;
      currentGroupForModal = group;
      variationPage = 1;
      document.getElementById("variationModalTitle").textContent = group.variants[0].title.replace(/\|.*/g, '');
      displayVariations();
      document.getElementById("variationModal").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function displayVariations() {
      const group = currentGroupForModal;
      const totalVariations = group.variants.length;
      const totalVariationPages = Math.ceil(totalVariations / variationsPerPage);
      const start = (variationPage - 1) * variationsPerPage;
      const end = start + variationsPerPage;
      const paginatedVariants = group.variants.slice(start, end);

      const grid = document.getElementById("variationModalGrid");
      grid.innerHTML = paginatedVariants.map(v => {
        const isOnSale = v.salePrice && v.salePrice < v.sellingPrice;
        const priceDisplay = isOnSale
          ? `<div class="text-xs text-center mt-1">
               <span class="text-red-600 line-through">${v.sellingPrice.toFixed(2)}</span><br>
               <span class="font-medium">AED ${v.salePrice.toFixed(2)}</span>
             </div>`
          : `<div class="text-xs text-center mt-1"><span class="font-medium">AED ${v.sellingPrice.toFixed(2)}</span></div>`;
        
        return `
          <div class="border p-2 rounded cursor-pointer hover:bg-gray-100" onclick="selectVariant('${v.sku}', this)">
            <img src="${v.image}" alt="${v.title}" class="w-full h-16 md:h-20 object-contain rounded mb-2" loading="lazy" onerror="this.src='https://via.placeholder.com/80?text=Variant'">
            <div class="text-xs text-center">
              ${v.color ? `<span class="font-medium">Color:</span> ${v.color}` : ""}
              ${v.size ? `<br><span class="font-medium">Size:</span> ${v.size}` : ""}
            </div>
            ${priceDisplay}
          </div>
        `;
      }).join("");

      const variationPagination = document.getElementById("variationPagination");
      if (totalVariations <= variationsPerPage) {
        variationPagination.classList.add("hidden");
      } else {
        variationPagination.classList.remove("hidden");
        variationPagination.innerHTML = `
          <button id="prevVariationPage" class="px-2 py-1 bg-gray-200 rounded-full hover:bg-gray-300 text-sm ${variationPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${variationPage === 1 ? 'disabled' : ''}>‚Üê</button>
          <span class="py-1 text-sm">Page ${variationPage} of ${totalVariationPages}</span>
          <button id="nextVariationPage" class="px-2 py-1 bg-gray-200 rounded-full hover:bg-gray-300 text-sm ${variationPage === totalVariationPages ? 'opacity-50 cursor-not-allowed' : ''}" ${variationPage === totalVariationPages ? 'disabled' : ''}>‚Üí</button>
        `;

        document.getElementById("prevVariationPage")?.addEventListener("click", () => {
          if (variationPage > 1) {
            variationPage--;
            displayVariations();
          }
        });
        document.getElementById("nextVariationPage")?.addEventListener("click", () => {
          if (variationPage < totalVariationPages) {
            variationPage++;
            displayVariations();
          }
        });
      }

      selectedVariant = null;
      document.getElementById("variationModalGrid").children[0]?.click();
    }

    function selectVariant(sku, el) {
      const cards = document.getElementById("variationModalGrid").children;
      for (let i = 0; i < cards.length; i++) {
        cards[i].classList.remove("border-green-600", "bg-green-100");
      }
      el.classList.add("border-green-600", "bg-green-100");
      selectedVariant = currentGroupForModal.variants.find(v => v.sku === sku);
    }

    document.getElementById("closeVariationModal").addEventListener("click", () => {
      document.getElementById("variationModal").classList.add("hidden");
      document.body.style.overflow = "";
    });

    document.getElementById("confirmVariation").addEventListener("click", () => {
      if (!selectedVariant) {
        alert("Please select a variant.");
        return;
      }
      loadCart();
      const existing = cart.find(item => item.sku === selectedVariant.sku);
      if (existing) {
        existing.quantity++;
      } else {
        cart.push({ ...selectedVariant, quantity: 1 });
      }
      updateCart();
      showCartDropdown(selectedVariant);
      // Track AddToCart event for Meta Pixel
      fbq('track', 'AddToCart', {
        content_ids: [selectedVariant.sku],
        content_type: 'product',
        value: selectedVariant.price,
        currency: 'AED'
      });
      document.getElementById("variationModal").classList.add("hidden");
      document.body.style.overflow = "";
    });

    function openProductPopup(group) {
      const base = group.variants[0];
      productPopupImage.src = base.image;
      productPopupImage.onerror = () => { this.src = 'https://via.placeholder.com/200?text=Product'; };
      productPopupTitle.textContent = `SKU: ${base.sku}\n${base.title.split("|")[0]}`;
      productPopupDescription.textContent = base.description;

      const isOnSale = base.salePrice && base.salePrice < base.sellingPrice;
      productPopupPrice.innerHTML = isOnSale
        ? `<div class="flex items-baseline"><span class="text-red-600 line-through text-sm">${base.sellingPrice.toFixed(2)}</span></div>
           <span class="text-blue-600 text-sm font-medium">AED ${base.salePrice.toFixed(2)}</span>`
        : `<span class="text-blue-600 text-sm font-medium">AED ${base.sellingPrice.toFixed(2)}</span>`;

      productPopupSelect.textContent = group.variants.length > 1 ? "Select Variant" : "Add to Cart";
      productPopupSelect.classList.remove("hidden");
      productPopupSelect.onclick = () => {
        if (group.variants.length > 1) {
          productPopup.classList.add("hidden");
          openVariationModal(group.model);
        } else {
          addToCart(base);
          productPopup.classList.add("hidden");
          document.body.style.overflow = "";
        }
      };
      productPopup.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    function enlargeImage(imageSrc, identifier) {
      productPopupImage.src = imageSrc;
      productPopupImage.onerror = () => { this.src = 'https://via.placeholder.com/200?text=Product'; };
      productPopupTitle.textContent = `SKU: ${identifier}`;
      productPopupDescription.textContent = "";
      productPopupPrice.textContent = "";
      productPopupSelect.classList.add("hidden");
      productPopup.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    closeProductPopup.addEventListener("click", () => {
      productPopup.classList.add("hidden");
      document.body.style.overflow = "";
    });

    productPopup.addEventListener("click", (e) => {
      if (e.target === productPopup) {
        productPopup.classList.add("hidden");
        document.body.style.overflow = "";
      }
    });

    cartModal.addEventListener("click", (e) => {
      if (e.target === cartModal) {
        cartModal.classList.add("hidden");
        document.body.style.overflow = "";
      }
    });

    async function loadProducts() {
      try {
        loadCart();
        const response = await fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSLAdm3vi00C8DPaMRjbxB9GWYiW_DHDFRRrdZtRP_qfifxZC6rMkcSIE2vavWWmicwW-jEfNf9IPh2/pub?gid=599223842&single=true&output=csv");
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const csvText = await response.text();
        console.log("CSV Text:", csvText);
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          transformHeader: header => header.trim().replace(/^"|"$/g, ""),
          transform: value => value.trim().replace(/^"|"$/g, ""),
          complete: results => {
            console.log("Parsed Data:", results.data);
            allProducts = results.data
              .filter(row => row["List/Unlist"] === "List" && row.SKU && row.Title && row["Selling Price"] && row.Model)
              .map(row => ({
                sku: row.SKU || "",
                model: row.Model || "",
                title: row.Title || "",
                category: row.Category || "Uncategorized",
                sellingPrice: parseFloat(row["Selling Price"]) || 0,
                salePrice: parseFloat(row["Sale Price"]) || null,
                color: row.Color || "",
                size: row.Size || "",
                description: row.Description || "A stylish and functional accessory for all your needs.",
                featured: row.Featured || "",
                image: row.SKU ? `Product_Images/${row.SKU}` : "",
                price: parseFloat(row["Sale Price"] && parseFloat(row["Sale Price"]) < parseFloat(row["Selling Price"]) ? row["Sale Price"] : row["Selling Price"]) || 0
              }))
              .filter(row => row.price > 0 && row.image);

            console.log("Filtered Products:", allProducts);

            const groups = {};
            allProducts.forEach(product => {
              const model = product.model;
              if (!groups[model]) groups[model] = [];
              groups[model].push(product);
            });

            groupedProducts = Object.keys(groups).map(model => ({
              model: model,
              variants: groups[model]
            })).sort((a, b) => {
              const aFeatured = a.variants.some(v => v.featured === "Y");
              const bFeatured = b.variants.some(v => v.featured === "Y");
              return bFeatured - aFeatured;
            });

            loading.classList.add("hidden");
            if (groupedProducts.length === 0) {
              error.textContent = "No products found.";
              error.classList.remove("hidden");
              return;
            }

            const categoriesSet = new Set();
            groupedProducts.forEach(group => {
              categoriesSet.add(group.variants[0].category);
            });
            const categories = ["Featured", "All", ...categoriesSet];
            categoryButtons.innerHTML = categories.map(cat => `
              <button class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm md:text-base font-medium shadow ${cat === "Featured" ? "bg-blue-800" : ""}" data-category="${cat}">${cat}</button>
            `).join("");
            displayProducts("Featured");
            updateCart();

            categoryButtons.querySelectorAll("button").forEach(btn => {
              btn.addEventListener("click", () => {
                categoryButtons.querySelectorAll("button").forEach(b => b.classList.remove("bg-blue-800"));
                btn.classList.add("bg-blue-800");
                currentPage = 1;
                currentCategory = btn.dataset.category;
                filteredGroupsCache = null;
                displayProducts(currentCategory, currentSearchQuery);
              });
            });

            searchInput.addEventListener("input", debounce((e) => {
              currentSearchQuery = e.target.value.toLowerCase();
              currentPage = 1;
              filteredGroupsCache = null;
              displayProducts(currentCategory, currentSearchQuery);
            }, 300));
          },
          error: err => {
            console.error("PapaParse Error:", err);
            loading.classList.add("hidden");
            error.textContent = "Error parsing product data. <button onclick='loadProducts()' class='underline'>Retry</button>";
            error.classList.remove("hidden");
          }
        });
      } catch (err) {
        console.error("Fetch Error:", err);
        loading.classList.add("hidden");
        error.textContent = "Failed to load products. <button onclick='loadProducts()' class='underline'>Retry</button>";
        error.classList.remove("hidden");
      }
    }

    function getFilteredGroups(category, searchQuery) {
      if (filteredGroupsCache && filteredGroupsCache.category === category && filteredGroupsCache.searchQuery === searchQuery) {
        return filteredGroupsCache.groups;
      }

      let filteredGroups = groupedProducts;

      if (searchQuery) {
        filteredGroups = groupedProducts.filter(group => 
          group.variants[0].title.toLowerCase().includes(searchQuery) || 
          group.model.toLowerCase().includes(searchQuery)
        );
      } else if (category === "Featured") {
        filteredGroups = groupedProducts.filter(group => group.variants.some(v => v.featured === "Y"));
      } else if (category !== "All") {
        filteredGroups = groupedProducts.filter(group => group.variants[0].category === category);
      }

      filteredGroupsCache = { category, searchQuery, groups: filteredGroups };
      return filteredGroups;
    }

    function displayProducts(category, searchQuery = "") {
      const filteredGroups = getFilteredGroups(category, searchQuery);
      const totalPages = Math.ceil(filteredGroups.length / productsPerPage);
      const start = (currentPage - 1) * productsPerPage;
      const end = Math.min(start + productsPerPage, filteredGroups.length);
      const paginatedGroups = filteredGroups.slice(start, end);

      const fragment = document.createDocumentFragment();
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = paginatedGroups.map(group => {
        const base = group.variants[0];
        const isOnSale = base.salePrice && base.salePrice < base.sellingPrice;
        const priceDisplay = isOnSale
          ? `<div class="flex items-baseline">
               <span class="text-red-600 line-through text-sm">${base.sellingPrice.toFixed(2)}</span>
             </div>
             <span class="text-blue-600 text-sm font-medium">AED ${base.salePrice.toFixed(2)}</span>`
          : `<span class="text-blue-600 text-sm font-medium">AED ${base.sellingPrice.toFixed(2)}</span>`;

        return `
          <div class="bg-white p-3 md:p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer flex flex-col relative">
            ${isOnSale ? `<span class="absolute top-2 right-2 text-lg md:text-xl">üî•</span>` : ''}
            <div class="flex-1" onclick="openProductPopup({ model: '${group.model}', variants: ${JSON.stringify(group.variants)} })">
              <h3 class="font-semibold text-xs md:text-sm leading-tight line-clamp-2 mb-1">SKU: ${base.sku}<br>${base.title.split("|")[0]}</h3>
              <p class="text-xs text-gray-600 leading-tight line-clamp-2 mb-2 md:mb-4">${base.description}</p>
            </div>
            <div class="w-full h-32 md:h-48">
              <img src="${base.image}.jpg" alt="${base.title}" class="w-full h-full object-contain rounded" loading="lazy" onerror="handleImageError(this, '${base.image}')" onclick="enlargeImage('${base.image}', '${base.sku}'); event.stopPropagation();">
            </div>
            <div class="mt-2 md:mt-4 flex justify-between items-center">
              <div class="flex flex-col">${priceDisplay}</div>
              <button class="add-to-cart px-2 md:px-3 py-1 bg-green-600 text-white text-xs md:text-sm rounded hover:bg-green-700" data-sku="${base.sku}" data-model="${group.model}">${group.variants.length > 1 ? 'Select' : 'Add to Cart'}</button>
            </div>
          </div>
        `;
      }).join("");
      
      while (tempDiv.firstChild) {
        fragment.appendChild(tempDiv.firstChild);
      }
      productsGrid.innerHTML = "";
      productsGrid.appendChild(fragment);

      pagination.innerHTML = `
        <button id="prevPage" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300 ${currentPage === 1 ? "opacity-50 cursor-not-allowed" : ""}" ${currentPage === 1 ? "disabled" : ""}>
          <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        </button>
        <span class="py-2 text-sm md:text-base">Page ${currentPage} of ${totalPages}</span>
        <button id="nextPage" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300 ${currentPage === totalPages ? "opacity-50 cursor-not-allowed" : ""}" ${currentPage === totalPages ? "disabled" : ""}>
          <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </button>
      `;

      const prevPage = document.getElementById("prevPage");
      const nextPage = document.getElementById("nextPage");
      if (prevPage) {
        prevPage.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            displayProducts(category, searchQuery);
          }
        });
      }
      if (nextPage) {
        nextPage.addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            displayProducts(category, searchQuery);
          }
        });
      }

      document.querySelectorAll(".add-to-cart").forEach(btn => {
        btn.addEventListener("click", e => {
          e.stopPropagation();
          const sku = btn.dataset.sku;
          const model = btn.dataset.model;
          const group = groupedProducts.find(g => g.model === model);
          if (group.variants.length > 1) {
            openVariationModal(model);
          } else {
            const product = allProducts.find(p => p.sku === sku);
            if (product) addToCart(product);
          }
        });
      });
    }

    function addToCart(product) {
      loadCart();
      const cartItem = cart.find(item => item.sku === product.sku);
      if (cartItem) {
        cartItem.quantity++;
      } else {
        cart.push({ ...product, quantity: 1 });
      }
      updateCart();
      showCartDropdown(product);
      // Track AddToCart event for Meta Pixel
      fbq('track', 'AddToCart', {
        content_ids: [product.sku],
        content_type: 'product',
        value: product.price,
        currency: 'AED'
      });
    }

    cartButton.addEventListener("click", () => {
      cartModal.classList.toggle("hidden");
      cartDropdown.classList.add("hidden");
      document.body.style.overflow = cartModal.classList.contains("hidden") ? "" : "hidden";
      // Track InitiateCheckout event for Meta Pixel
      if (!cartModal.classList.contains("hidden") && cart.length > 0) {
        fbq('track', 'InitiateCheckout', {
          value: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
          currency: 'AED',
          content_ids: cart.map(item => item.sku),
          content_type: 'product'
        });
      }
    });

    closeCart.addEventListener("click", () => {
      cartModal.classList.add("hidden");
      document.body.style.overflow = "";
    });

    checkout.addEventListener("click", () => {
      if (cart.length === 0) return;
      const orderNumber = Math.floor(100000 + Math.random() * 900000);
      const items = cart.map(item => `${item.sku} x ${item.quantity} = ${(item.price * item.quantity).toFixed(2)}`).join("\n");
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
      const courier = subtotal > 100 ? "Free" : "AED 15.00";
      const total = subtotal + (subtotal > 100 ? 0 : 15);
      // Track Purchase event for Meta Pixel
      fbq('track', 'Purchase', {
        value: total,
        currency: 'AED',
        content_ids: cart.map(item => item.sku),
        content_type: 'product',
        order_id: orderNumber
      });
      const message = `Order #${orderNumber}\n\nHello! I would like to place order for\n${items}\n\nSub: ${subtotal.toFixed(2)} AED\nShipping: ${courier}\nTotal: ${total.toFixed(2)} AED`;
      const whatsappUrl = `https://wa.me/+971568743529?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, "_blank");
      cart = [];
      updateCart();
      cartModal.classList.add("hidden");
      document.body.style.overflow = "";
    });

    window.addEventListener("scroll", () => {
      if (window.scrollY > 300) {
        backToTop.classList.remove("hidden");
      } else {
        backToTop.classList.add("hidden");
      }
    });

    backToTop.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    document.addEventListener("DOMContentLoaded", loadProducts);
    function handleImageError(img, basePath) {
      if (!img.attempts) img.attempts = 0;
      img.attempts++;
      if (img.attempts === 1) {
        img.src = basePath + ".jpeg";
      } else if (img.attempts === 2) {
        img.src = basePath + ".png";
      } else {
        img.src = "https://via.placeholder.com/200?text=Product";
      }
    }
  </script>
  </body>
  </html>
